---
title: "CMake 正确打开方法"
summary: "讨论如何基于 CMake 构建自己的工作流程，包括构建、依赖管理、测试"
author: ["wivl"]
date: 2024-11-13
tags: ["cpp"]
weight: 1
ShowToc: true
draft: false
---

> 未完成

## 前言

与其他 "modern" 语言相比，cpp 是一个混乱的语言：不同平台的编译器的实现不同；不同版本 cpp 标准之间的差距大；缺少官方工具链。尤其是在接触了 rust 之后，我意识到有一个官方的、好用的项目管理器可以有多舒服。而这些正是 cpp 缺少的东西。cpp 标准并没有规定项目的结构。这就导致开发者往往以自己的喜好来选择工具链和组织自己的项目。一方面构建这些项目需要用不同的方式让人十分恼火，另一方面，像我这样的初学者在尝试开发自己的 cpp 项目时，在选择自己的工作流程方面容易感到迷茫。我尝试找到一种合理的工作流程，于是有了这篇文章。

## 一个完整的 cpp 项目应该包括什么

一个小/中型的 cpp 项目往往包含以下内容/需求：

- **多个源文件**，意味着你需要在项目中使用**构建工具**
- **第三方依赖**，意味着你*很可能*需要一个**包管理器**
- **跨平台需求**，意味着你需要有措施可以使得代码在不同系统上运行
- 测试，版本管理和其他

## 为什么选择 CMake

在讨论为什么选择 CMake 之前，先让我们看看市面上的其他类似工具。

xmake 是由中国开发者开发的构建工具。它使用 Lua 作为其构建脚本（build scripts）的描述语言。xmake 附带一个包管理器 xrepo。xmake 也可以作为项目管理器。基本上可以认为 xmake = 项目管理器 + 构建工具 + 包管理器，相当于属于 cpp 自己的 cargo。我曾经有一段时间一直在使用 xmake，在终端 + nvim 的工作流程里体验很不错。但是虽然 xmake 在大部分编辑器里都有插件支持，在其他编辑器/IDE 里用 xmake 的体验还是很割裂，第三方工具对 xmake 的支持并不好。

premake5 似乎在国外开发者社区里具有一定的流行度，它同样使用 Lua 作为构建脚本描述语言，提供了类似 CMake 的生成多平台构建配置的功能。premake 的构建脚本要比 CMakeLists 简洁得多，但是它支持的平台类型数量远不如 CMake。

市面上还有其他体量足够大的 cpp 构建工具，如 Meson 和 Bazel。它们都在社区中足够受欢迎，并且相较于 CMake 都有自己的优势。对于这些构建工具还请读者自己去探索，我不想把所有的构建工具都列出来评价，因为其中有一些构建工具我从来没有上手使用过。

老实说，这些构建工具相对于 CMake 都多多少少有一定的可取之处。既然这样，我为什么要使用 CMake？理由很简单：因为大多数 cpp 开发者都在使用 CMake。你在 Github 里浏览的 cpp 项目，无论是库还是可执行文件，它们很有可能使用的就是 CMake。换言之 CMake 具有最庞大的社区，当所有人都在使用 CMake 时，我们最好也使用 CMake，以获得最好的社区支持。

但同时我们不得不承认 CMake 存在一些问题。首先和 cpp 一脉相承的是，CMake 是一个具有历史底蕴的构建工具，构建脚本有很多种写法。我试图在这些写法中找到一种方便的、现代的方式来管理源文件、第三方依赖和测试，建立自己的工作流。


## 构建项目

### 拥抱 CMakePresets



## 管理第三方依赖

### 使用 vcpkg

## CI

## 添加测试

## 自动化脚本